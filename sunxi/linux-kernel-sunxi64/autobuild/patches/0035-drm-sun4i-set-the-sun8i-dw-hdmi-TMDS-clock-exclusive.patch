From 3902437cc4eaa146fe6d92f11c68474c8562c085 Mon Sep 17 00:00:00 2001
From: Icenowy Zheng <icenowy@aosc.io>
Date: Thu, 16 Aug 2018 21:53:02 +0800
Subject: [PATCH 035/131] drm: sun4i: set the sun8i-dw-hdmi TMDS clock
 exclusively when enabling

On H3/H5/A64/R40 the HDMI PHY clock is set after the the mode_set() of
the HDMI encoder is called. As the PHY clock has the same parent with
the TMDS clock (PLL-VIDEO{0,1}), it may mess up TMDS clock.

Set the rate of TMDS clock only when enabling, and add exclusivity to
it. Drop the exclusivity when disabling, to allow the change of other
clocks connected under the PLL.

Signed-off-by: Icenowy Zheng <icenowy@aosc.io>
---
 drivers/gpu/drm/sun4i/sun8i_dw_hdmi.c | 20 +++++++++++++++++++-
 drivers/gpu/drm/sun4i/sun8i_dw_hdmi.h |  1 +
 2 files changed, 20 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/sun4i/sun8i_dw_hdmi.c b/drivers/gpu/drm/sun4i/sun8i_dw_hdmi.c
index 39d8509d96a0..fc710926a215 100644
--- a/drivers/gpu/drm/sun4i/sun8i_dw_hdmi.c
+++ b/drivers/gpu/drm/sun4i/sun8i_dw_hdmi.c
@@ -22,12 +22,30 @@ static void sun8i_dw_hdmi_encoder_mode_set(struct drm_encoder *encoder,
 	struct sun8i_dw_hdmi *hdmi = encoder_to_sun8i_dw_hdmi(encoder);
 
 	if (hdmi->quirks->set_rate)
-		clk_set_rate(hdmi->clk_tmds, mode->crtc_clock * 1000);
+		hdmi->clk_tmds_freq = mode->crtc_clock * 1000;
+}
+
+static void sun8i_dw_hdmi_encoder_enable(struct drm_encoder *encoder)
+{
+	struct sun8i_dw_hdmi *hdmi = encoder_to_sun8i_dw_hdmi(encoder);
+
+	if (hdmi->quirks->set_rate)
+		clk_set_rate_exclusive(hdmi->clk_tmds, hdmi->clk_tmds_freq);
+}
+
+static void sun8i_dw_hdmi_encoder_disable(struct drm_encoder *encoder)
+{
+	struct sun8i_dw_hdmi *hdmi = encoder_to_sun8i_dw_hdmi(encoder);
+
+	if (hdmi->quirks->set_rate)
+		clk_rate_exclusive_put(hdmi->clk_tmds);
 }
 
 static const struct drm_encoder_helper_funcs
 sun8i_dw_hdmi_encoder_helper_funcs = {
 	.mode_set = sun8i_dw_hdmi_encoder_mode_set,
+	.enable = sun8i_dw_hdmi_encoder_enable,
+	.disable = sun8i_dw_hdmi_encoder_disable,
 };
 
 static const struct drm_encoder_funcs sun8i_dw_hdmi_encoder_funcs = {
diff --git a/drivers/gpu/drm/sun4i/sun8i_dw_hdmi.h b/drivers/gpu/drm/sun4i/sun8i_dw_hdmi.h
index 720c5aa8adc1..556a32260207 100644
--- a/drivers/gpu/drm/sun4i/sun8i_dw_hdmi.h
+++ b/drivers/gpu/drm/sun4i/sun8i_dw_hdmi.h
@@ -182,6 +182,7 @@ struct sun8i_dw_hdmi_quirks {
 
 struct sun8i_dw_hdmi {
 	struct clk			*clk_tmds;
+	unsigned long			clk_tmds_freq;
 	struct device			*dev;
 	struct dw_hdmi			*hdmi;
 	struct drm_encoder		encoder;
-- 
2.18.1

