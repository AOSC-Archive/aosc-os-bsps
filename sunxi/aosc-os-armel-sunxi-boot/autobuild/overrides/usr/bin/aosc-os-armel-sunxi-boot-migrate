#! /bin/bash
set -e
if [ ! -e /etc/aosc-arm.conf ]; then
	echo "AOSC ARM configuration file not found!" >&2
	exit 1
fi
. /etc/aosc-arm.conf
case "$DEVICE_NAME" in
	sun[45]i-*)
		KVM=nokvm ;;
	sun[6789]i-*)
		KVM=kvm ;;
	*)
		echo "Not a sunxi 32-bit device!" >&2
		exit 1 ;;
esac

echo "Installing U-Boot Helpers from AOSC..."
apt install u-boot-aosc-utils -y
echo "Installing Kernel..."
apt install linux+kernel+sunxi+$KVM -y
echo "Installing U-Boot..."
apt install u-boot-$DEVICE_NAME -y
echo "Setting up..."
if grep -q 'mmcblk2p2' /etc/fstab; then
	wget https://github.com/AOSC-Dev/u-boot-aosc-utils/raw/62291c87fb7b6e76c6ee7737b309d9a0659506a8/presets/sunxi-mmc2 -O /etc/default/u-boot
else
	wget https://github.com/AOSC-Dev/u-boot-aosc-utils/raw/62291c87fb7b6e76c6ee7737b309d9a0659506a8/presets/sunxi -O /etc/default/u-boot
fi
update-u-boot
echo "Cleaning up..."
apt purge aosc-os-armel-sunxi-boot -y
